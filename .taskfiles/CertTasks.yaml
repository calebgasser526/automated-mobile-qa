---
version: "3"

vars:
  CERT_NAME: "mitmproxy"
  CERT_DIR: "$HOME/.mitmproxy"
  ADB: "{{.PROJECT_DIR}}/android_local_sdk/platform-tools/adb"

tasks:
  clean:
    desc: Remove mimtproxy certificates.
    cmds:
      - rm -fr $HOME/.mitmproxy

  install:
    desc: Install certificate to android device and system.
    deps: [system]
    cmds:
      - ./install-android-certificate.sh {{.ADB}}
    preconditions:
      - sh: test -d "{{.PROJECT_DIR}}/android_local_sdk/platform-tools"
        msg: |
          The local android sdk does not appear to have adb. Did you run 'task android:install'?

  system:
    deps: [gen]
    desc: Install certificate to system.
    cmds:
      - sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain {{.CERT_FILE}}
    status:
      - test "$(security find-certificate -c '{{.CERT_NAME}}' -a)"
  gen:
    desc: Generate's certificate for mitmproxy.
    desp: [python:depends]
    cmds:
      - source ./.venv/bin/activate && npm run gen-cert
    status:
      - test -f $HOME/.mitmproxy/mitmproxy-ca-cert.cer
