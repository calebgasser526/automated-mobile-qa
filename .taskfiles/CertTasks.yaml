---
version: "3"

vars:
  CERT_NAME: "mitmproxy"
  CERT_FILE: "mitmproxy-ca-cert.cer"
  CERT_PATH: "{{.PROJECT_DIR}}/{{.CERT_FILE}}"

tasks:
  clean:
    desc: Remove mimtproxy certificates.
    cmds:
      - cmd: rm {{.PROJECT_DIR}}/{{.CERT_FILE}}
        ignore_error: true
      - cmd: rm {{.PROJECT_DIR}}/*.0
        ignore_error: true

  get:
    desc: Download the proxy cert from the container.
    cmds:
      - rm {{.PROJECT_DIR}}/mitmproxy-*
      - ./hack/get-cert.sh localhost:{{.PROXY_WEB_FILE_PORT}}/{{.CERT_FILE}} {{.CERT_FILE}}

  system:install:
    deps: [get]
    desc: Install certificate to system.
    cmds:
      - cmd: sudo security delete-certificate -c mitmproxy /Library/Keychains/System.keychain
        ignore_error: true
      - sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain {{.CERT_FILE}}

  android:install:
    deps: [get]
    desc: Install certificate to android device.
    cmds:
      - ./hack/install-android-certificate.sh "{{.PROJECT_DIR}}/.android_local_sdk/platform-tools/adb" {{.CERT_PATH}}
    preconditions:
      - sh: test -d "{{.PROJECT_DIR}}/.android_local_sdk/platform-tools"
        msg: |
          The local android sdk does not appear to have adb. Did you run 'task android:install'?
