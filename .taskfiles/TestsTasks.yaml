---
version: "3"

tasks:
  run:
    desc: Run all test for both iOS and Android.
    cmds:
      - task: run:android
      - task: run:ios

  run:android:
    desc: Run tests for android.
    cmds:
      - cmd: |
          lima nerdctl exec \
          -e TEST_PLATFORM=Android \
          -e TEST_ID={{.ANDROID_TEST_UUID}} \
          -e ANDROID_APK={{.ANDROID_APK}} \
          -e IOS_APP={{.IOS_APP}} \
          mtest task python:test:android
        ignore_error: true

  run:ios:
    desc: Run tests for iOS.
    env:
      IOS_UDID:
        sh: echo $(xcrun simctl list --json | jq --raw-output '.devices."com.apple.CoreSimulator.SimRuntime.iOS-15-0"[] | select(.name=="appium") | .udid')
      TEST_PLATFORM: "IOS"
      TEST_ID:
        sh: echo "{{.IOS_APP_FILE}}__$(uuidgen)"
      ANDROID_APK: ""
      IOS_APP:
        sh: echo "{{.PROJECT_DIR}}/Realtor.com.app"
    cmds:
      - cmd: |
          task python:test:ios
        ignore_error: true
    vars:
      IOS_UDID:
        sh: echo $(xcrun simctl list --json | jq '.devices."com.apple.CoreSimulator.SimRuntime.iOS-15-0"[] | select(.name=="appium") | .udid')
