---
version: "3"

tasks:
  local:test:android:
    deps: [requirements:local]
    desc: Run android appium test.
    cmds:
      - cmd: source {{.PROJECT_DIR}}/.venv/bin/activate && python -m pytest -s ./mtest/appium_test/test_android.py
        ignore_error: true

  local:test:ios:
    deps: [requirements:local]
    desc: Run ios appium test.
    cmds:
      - cmd: source {{.PROJECT_DIR}}/.venv/bin/activate && python -m pytest -s ./mtest/appium_test/test_ios.py
        ignore_error: true

  requirements:mtest:
    deps: [virt]
    desc: Install python requirements into the mtest container virtual environment.
    cmds:
      - source {{.PROJECT_DIR}}/.venv/bin/activate && pip install -r requirements_mtest.txt
    status:
      - test -d {{.PROJECT_DIR}}/.venv/lib/python3.8/site-packages/mitmproxy

  requirements:local:
    deps: [virt]
    desc: Install python requirements into the local virtual environment.
    cmds:
      - source {{.PROJECT_DIR}}/.venv/bin/activate && pip install -r requirements_local.txt
    status:
      - test -d {{.PROJECT_DIR}}/.venv/lib/python3.8/site-packages/Appium_Python_Client*

  virt:
    desc: Create python virtual environment.
    deps: [version]
    cmds:
      - python -m venv .venv
    status:
      - test -d {{.PROJECT_DIR}}/.venv

  version:
    desc: Install and set python version {{.PYTHON_VERSION}}.
    cmds:
      - pyenv install -s {{.PYTHON_VERSION}}
      - pyenv global {{.PYTHON_VERSION}}
    status:
      - test "$(python --version)" -eq "Python {{.PYTHON_VERSION}}"
    preconditions:
      - sh: command -v pyenv
        msg: |
          Pyenv is not installed. Have you run 'task install'?
  clean:
    desc: Remove python virtual environment.
    cmds:
      - rm -fr {{.PROJECT_DIR}}/.venv
