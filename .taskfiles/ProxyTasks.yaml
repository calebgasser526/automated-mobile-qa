---
version: "3"

vars:
  ADDON_FILE: "{{.PROJECT_DIR}}/mtest/mitmproxy_addon.py"

tasks:
  run:
    desc: Run mitm proxy with addon.
    cmds:
      - source {{.PROJECT_DIR}}/.venv/bin/activate && mitmdump -s {{.ADDON_FILE}} --set confdir={{.PROJECT_DIR}} --set listen_host={{.PROXY_HOST}} --set listen_port={{.PROXY_PORT}}

  run:cli:
    desc: Run mitm proxy with addon.
    cmds:
      - source {{.PROJECT_DIR}}/.venv/bin/activate && mitmproxy -s {{.ADDON_FILE}} --set confdir={{.PROJECT_DIR}} --set listen_host={{.PROXY_HOST}} --set listen_port={{.PROXY_PORT}}

  run:web:
    desc: Run mitm proxy with addon.
    cmds:
      - source {{.PROJECT_DIR}}/.venv/bin/activate && mitmweb -s {{.ADDON_FILE}} --set confdir={{.PROJECT_DIR}} --set listen_host={{.PROXY_HOST}} --set listen_port={{.PROXY_PORT}} --set web_port={{.PROXY_WEB_PORT}} --set web_host={{.PROXY_WEB_HOST}} --set open_web_browser=false

  setup:
    desc: Set proxy settings.
    cmds:
      - networksetup -setwebproxy "{{.PROXY_TARGET}}" {{.PROXY_IP}} {{.PROXY_PORT}}
      - networksetup -setsecurewebproxy "{{.PROXY_TARGET}}" {{.PROXY_IP}} {{.PROXY_PORT}}
      - networksetup -setwebproxystate "{{.PROXY_TARGET}}" on
      - networksetup -setsecurewebproxystate "{{.PROXY_TARGET}}" on

  restore:
    desc: Restore proxy settings.
    cmds:
      - networksetup -setwebproxy "{{.PROXY_TARGET}}" {{.ORIG_PROXY_IP}} {{.ORIG_PROXY_PORT}}
      - networksetup -setsecurewebproxy "{{.PROXY_TARGET}}" {{.ORIG_SECURE_PROXY_IP}} {{.ORIG_SECURE_PROXY_PORT}}
      - networksetup -setwebproxystate "{{.PROXY_TARGET}}" off
      - networksetup -setsecurewebproxystate "{{.PROXY_TARGET}}" off
