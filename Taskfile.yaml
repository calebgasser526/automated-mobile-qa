---
version: "3"

dotenv: ["config.env"]

vars:
  CONFIG_FILE: "config.env"
  PROJECT_NAME: $PROJECT_NAME
  PROJECT_DIR:
    sh: pwd
  ANDROID_APK: "{{.PROJECT_DIR}}/BuyRent-core-debug.apk"
  IOS_APP: "{{.PROJECT_DIR}}/Realtor.com.app"
  PROXY_TARGET: "Wi-fi"
  PROXY_IP: "127.0.0.1"
  PROXY: "{{.PROXY_IP}}:{{.PROXY_PORT}}"
  PROXY_PORT: $PROXY_PORT
  PROXY_WEB_HOST: $PROXY_WEB_HOST
  PROXY_WEB_PORT: $PROXY_WEB_PORT
  PROXY_WEB_FILE_PORT: $PROXY_WEB_FILE_PORT
  POSTGRES_DB: $POSTGRES_DB
  POSTGRES_USER: $POSTGRES_USER
  POSTGRES_PASSWORD: $POSTGRES_PASSWORD
  ADMINER_PORT: $ADMINER_PORT
  GRAFANA_PORT: $GRAFANA_PORT
  ORIG_PROXY_IP:
    sh: networksetup -getwebproxy 'Wi-fi' | awk '/Server:/{print $NF}'
  ORIG_PROXY_PORT:
    sh: networksetup -getwebproxy 'Wi-fi' | awk '/Port:/{print $NF}'
  ORIG_SECURE_PROXY_IP:
    sh: networksetup -getsecurewebproxy 'Wi-fi' | awk '/Server:/{print $NF}'
  ORIG_SECURE_PROXY_PORT:
    sh: networksetup -getsecurewebproxy 'Wi-fi' | awk '/Port:/{print $NF}'
  PYTHON_VERSION: "3.9.12"

includes:
  init: .taskfiles/InitTasks.yaml
  python: .taskfiles/PythonTasks.yaml
  node: .taskfiles/NodeTasks.yaml
  cert: .taskfiles/CertTasks.yaml
  android: .taskfiles/AndroidTasks.yaml
  proxy: .taskfiles/ProxyTasks.yaml
  test: .taskfiles/TestsTasks.yaml
  appium: .taskfiles/AppiumTasks.yaml
  container: .taskfiles/ContainerTasks.yaml

tasks:
  default:
    desc: Run all tests.
    cmds:
      - echo {{.PROXY_WEB_PORT}}

  all:tests:
    desc: Run all tests.
    deps: [install]
    cmds:
      - task: proxy:setup
      - task: appium:start
      - task: android:run
      - task: cert:system:install
      - task: test:run:android
      - task: test:run:ios
      - defer: { task: restore }
      - task: report

  android:test:
    desc: Run android tests only.
    deps: [install, container:up, appium:start, android:run]
    cmds:
      - task: cert:android:install
      - task: test:run:android
      - defer: { task: restore }

  ios:test:
    desc: Run iOS tests only.
    deps: [install]
    cmds:
      - task: container:up
      - task: appium:start
      - task: cert:ios:install
      - task: python:local:test:ios
      - defer: { task: restore }

  restore:
    desc: Restore state after running tests.
    cmds:
      - defer: { task: android:stop }
      - defer: { task: appium:stop }
      - defer: { task: proxy:restore }

  install:
    desc: Install requirements for running tests.
    cmds:
      - task: init:install

  open:proxy:
    desc: Opens the proxy UI.
    cmds:
      - open http://{{.PROXY_WEB_HOST}}:{{.PROXY_WEB_PORT}}

  open:proxy:files:
    desc: Opens the file server on the proxy.
    cmds:
      - open http://{{.PROXY_WEB_HOST}}:{{.PROXY_WEB_FILE_PORT}}

  clean:
    desc: Remove all generated project files.
    cmds:
      - task: container:lima:rm
      - task: restore
      - task: android:clean
      - task: python:clean
      - task: node:clean
      - task: cert:clean
